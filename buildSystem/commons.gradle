// v1.0.5

task fetchFromGit(type: Exec) {
    description 'Fetch git.'
    commandLine "git", "fetch"
}

task addToGit(type: Exec) {
    description 'Add git.'
    commandLine "git", "add", "-A"
}

task pushToGit(type: Exec) {
    description 'Push git.'
    commandLine "git", "push"
}

task hola() {
    println("hola")
}

task hola2() {
    println("hola2")
}

task deployLibrary() {
    doFirst {
        println("deployLibrary")
    }
    dependsOn(createUpdateReadmeTask(version))
    dependsOn(fetchFromGit)
    dependsOn(addToGit)
    dependsOn(createCommitToGitWithMessageTask("Library version increased (" + version + ")"))
    dependsOn(pushToGit)
    dependsOn(createTagToGitTask(version, "Release candidate"))
    dependsOn(createPushTagToGitTask(version))
}

def createCommitToGitWithMessageTask(message) {
    return tasks.create(name: 'commitToGitWithMessage', type: Exec) {
        description 'Commit git.'
        commandLine "git", "commit", "-m", message
    }
}

def createTagToGitTask(tag, message) {
    return tasks.create(name: 'createTagToGit', type: Exec) {
        description 'Tag git.'
        commandLine "git", "tag", "-a", tag, "-m", message
    }
}

def createPushTagToGitTask(tag) {
    return tasks.create(name: 'pushTagToGit', type: Exec) {
        description 'Push tag to git.'
        commandLine "git", "push", "origin", tag
    }
}

def createUpdateReadmeTask(versionName) {
    return tasks.create(name: 'updateReadme') {
        doFirst {
            println(":updateReadmeFile - Updating readme file...")
            def readmeFile = file('README.md')
            if (readmeFile.exists()) {
                readmeFile.delete()
            }
            def readmeTemplateFile = file('README.template')
            if (readmeTemplateFile.canRead()) {
                def content = readmeTemplateFile.getText("UTF-8").replaceAll("\\{versionName\\}", versionName)
                readmeFile = new File("README.md")
                readmeFile.createNewFile()
                readmeFile.write(content, "UTF-8")
            }
            println(":updateReadmeFile - Readme file has been update")
        }
    }
}